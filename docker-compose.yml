version: '3.8'

services:
  article-crawler:
    build: .
    container_name: zendesk-crawler
    volumes:
      # Persist database, output files, and logs on host
      - ./data:/app/data
      - ./output:/app/output
      - ./logs:/app/logs
      - ./keys:/app/keys:ro  # Read-only mount for GCP credentials
    environment:
      # Timezone
      - TZ=Asia/Ho_Chi_Minh
      
      # Docker environment marker
      - DOCKER_CONTAINER=1
      
      # Zendesk API Configuration
      - ZENDESK_API_URL=${ZENDESK_API_URL}
      
      # GCP Configuration
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCS_BUCKET_NAME=${GCS_BUCKET_NAME}
      - VERTEX_AI_DATA_STORE_ID=${VERTEX_AI_DATA_STORE_ID}
      - VERTEX_AI_LOCATION=${VERTEX_AI_LOCATION:-us}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/keys/service-account-key.json
      
      # Database and output paths
      - DB_PATH=/app/data/articles.db
      - OUTPUT_PATH=/app/output
    restart: unless-stopped
    # Healthcheck to ensure cron is running
    healthcheck:
      test: ["CMD", "pgrep", "cron"]
      interval: 60s
      timeout: 10s
      retries: 3